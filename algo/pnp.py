import numpy as np
import cv2
import copy

K = np.array([
    [7.6461e3, 0, 3840],
    [0, 8.0612e3, 2160],
    [0, 0, 1]
])

# m_L_t = [-3.1139333859318867, 6.238793021067977, 0.32044752035290003, -3.1704712180653587, 6.222299265209585, 0.3225384121760726, -3.3400799822993577, 6.172817207407206, 0.328854707069695, -5.40185495337937, 5.247902400791645, 0.3998420303687453, -2.850888140441384, 5.53984957979992, 0.2834578175097704, -3.246670462191105, 5.424404378049076, 0.29819840006530285, -2.855792915332131, 5.344479801598936, 0.2769969180226326, -3.974195730232168, 4.759633168578148, 0.3111640103161335, -2.882807243266143, 5.013351728674024, 0.2671071207150817, -5.126684426562861, 4.294009875040501, 0.3542262790724635, -2.88770231930539, 4.817964439280331, 0.26086225267499685, -4.809712010202929, 4.257228689733893, 0.3367947367951274, -4.979254057456274, 4.207746884785593, 0.34389782324433327, -2.95402498182375, 4.410680876579136, 0.2507409490644932, -2.976129238726571, 4.274914436042309, 0.2474465537816286, -2.5900669260299765, 3.999508057255298, 0.22074575629085302, -2.8087741201161407, 3.4830542039126158, 0.21508361492305994, -2.5702188064460643, 3.293913264758885, 0.1983334757387638, -3.637013773084618, 2.5301195848733187, 0.22677702363580465, -2.906842838798184, 2.5489874351769686, 0.19246426597237587, -4.155496020452119, 1.9908389439806342, 0.2373462552204728, -3.1771775727975182, 2.2114402567967772, 0.19585091341286898, -4.081741145870183, 1.9476692066527903, 0.23253236524760723, -2.9903149522142485, 2.201235247310251, 0.18672830797731876, -2.938612123078201, 2.022249923553318, 0.1794208474457264, -4.351989244809374, 1.6101254126988351, 0.2370107714086771, -3.034466767217964, 1.9296184401027858, 0.18144126422703266, -4.22171003674157, 1.5834378441795707, 0.22981741651892662, -2.7910472460789606, 1.9358907537534833, 0.17017860524356365, -2.038619584054686, 2.0905078719370067, 0.13981217052787542, -2.886904683255125, 1.8432585382834077, 0.17218616232275963, -1.9475778184714727, 1.9876540140248835, 0.13292861729860306, -2.004136988951359, 1.9711715918965638, 0.1350287375971675, -4.135558758687694, 1.2851347560063004, 0.21784354746341705, -2.8179542990401387, 1.6045940718613565, 0.16265314258635044, -2.0655270798597485, 1.759198209270835, 0.13213647156953812, -2.2007130059646443, 1.590410630684346, 0.13382205832749605, -2.709687472495716, 1.4420712837018073, 0.15337895136326551, -3.9928645153413527, 1.0032986523583531, 0.20369525719434023, -3.9239223426557146, 0.7646309589035809, 0.19442334305495024, -4.076276295061689, 0.6555159264244139, 0.19927748385816813, -2.967587530205492, 0.8493271837942302, 0.1505147246643901, -3.7026100159273483, 0.6350686899386346, 0.18046767730265856, -2.4807062249747105, 0.8618245371617377, 0.12815279327332973, -2.820007572241593, 0.762940944172442, 0.14147583674639463, -2.5200128370779566, 0.7856678976677358, 0.12809723988175392, -3.4075000805896707, 0.46230422239750624, 0.16207440569996834, -2.4855200966703705, 0.6663137814030051, 0.12360576167702675, -2.6379280692199245, 0.5571963745169342, 0.12802305817604065, -2.6772315994021483, 0.481038689147681, 0.12802915554493666, -3.6998030796530657, -0.011106707621365786, 0.16518350318074226, -1.9516270353342406, 0.30422147596254945, 0.09069831669330597, -2.600591149821412, -0.208410928491503, 0.10856924951076508, -1.282446766330395, 0.11087749432772398, 0.05661544483155012, -2.357127165829297, -0.20218584733083844, 0.0974992336705327, -2.1136478151893243, -0.1959633082151413, 0.08655352331697941, -2.73573812720133, -0.377211912535131, 0.11110366974025965, -1.4051688259351067, -0.3131691827438772, 0.05240246839821339, -1.8404292451450601, -0.5046663996763527, 0.06745862495154142, -2.0101114879362285, -0.5540938335470855, 0.0740017369389534, -1.879732587665785, -0.5808329037390649, 0.06756872590631247, -1.7320894937147386, -0.6672655493021011, 0.05912533309310675, -3.315549864026252, -1.1285766521468759, 0.12253836821764708, -2.189353292924352, -0.9946173797361553, 0.07279284950345755, -2.359020717383828, -1.044041687157005, 0.0795109486207366, -2.5852325730375014, -1.1099409135058522, 0.08857024740427732, -2.681076409004163, -1.2025812463834882, 0.0911288121715188, -2.041717579239048, -1.0810542525723577, 0.06432867888361216, -2.1548341708257794, -1.1140029267407954, 0.06877112109214067, -1.2325491713127121, -0.9101119735278189, 0.03204754926264286, -2.646560635766946, -1.3219641293399036, 0.08712366037070751, -1.4070320645114407, -1.1550984443165362, 0.034605843015015125, -1.7464253510697745, -1.2539390856400132, 0.04758437164127827, -2.312017599178944, -1.4186743879690766, 0.0697973808273673, -2.4251263779005967, -1.451621528249234, 0.07432728167623281, -2.4816795415827073, -1.4680951037444174, 0.07660314347594976, -1.842287119361572, -1.3465824481099844, 0.05000237748026848, -2.35131143219769, -1.4948425060138106, 0.07009248808026314, -3.029907481337432, -1.6925228633917868, 0.09779578074812889, -1.5987689507892355, -1.3403869769535959, 0.03930425085127354, -2.9388442156487145, -1.7954354295507073, 0.0915395263582468]

# p_t = [50.9931640625, 2413.0556640625, 3551.006591796875, 2414.01953125, 3551.000244140625, 2417.0, 3555.94775390625, 2454.551025390625, 3562.99658203125, 2412.01025390625, 3562.999267578125, 2419.000732421875, 3566.0, 2413.000732421875, 3569.91162109375, 2433.99560546875, 3571.0, 2415.0, 3572.777099609375, 2455.10009765625, 3574.0, 2416.0, 3574.0, 2450.0, 3576.8349609375, 2451.694580078125, 3577.95751953125, 2418.353759765625, 3581.61279296875, 2419.868896484375, 3587.6796875, 2414.96826171875, 3594.760498046875, 2421.05615234375, 3599.136962890625, 2417.654296875, 3606.31494140625, 2438.9765625, 3608.4658203125, 2427.242431640625, 3611.999267578125, 2450.001953125, 3612.952392578125, 2433.125, 3613.00537109375, 2449.0146484375, 3614.0, 2431.0, 3616.96484375, 2431.051025390625, 3617.01513671875, 2455.072021484375, 3618.045166015625, 2433.45068359375, 3618.008544921875, 2452.93310546875, 3618.998779296875, 2429.001708984375, 3619.941162109375, 2415.053466796875, 3620.013427734375, 2431.4140625, 3621.9853515625, 2413.997802734375, 3622.04150390625, 2414.990234375, 3622.989013671875, 2453.01953125, 3623.369140625, 2429.902099609375, 3624.686767578125, 2416.010986328125, 3627.400390625, 2422.89208984375, 3627.00048828125, 2428.999755859375, 3628.0, 2453.0, 3632.03759765625, 2452.973876953125, 3633.098388671875, 2455.1025390625, 3633.719482421875, 2437.528564453125, 3635.033447265625, 2448.9169921875, 3637.03125, 2428.974365234375, 3637.004638671875, 2434.193115234375, 3637.999267578125, 2429.99951171875, 3638.922607421875, 2444.9921875, 3640.0, 2430.0, 3641.098876953125, 2432.48876953125, 3641.923095703125, 2433.495849609375, 3644.998291015625, 2451.996826171875, 3648.0107421875, 2422.57958984375, 3653.994873046875, 2435.02099609375, 3654.11181640625, 2412.660400390625, 3653.93994140625, 2431.027099609375, 3654.99755859375, 2427.966796875, 3655.1884765625, 2438.009521484375, 3659.997802734375, 2417.001953125, 3659.0283203125, 2424.985107421875, 3659.0, 2428.0, 3660.0, 2426.000244140625, 3664.946044921875, 2423.0625, 3664.0, 2451.0, 3666.99267578125, 2432.004150390625, 3667.0078125, 2436.019287109375, 3666.59716796875, 2439.4384765625, 3668.0029296875, 2442.011474609375, 3669.124755859375, 2429.977783203125, 3668.99951171875, 2432.001220703125, 3669.836181640625, 2416.117431640625, 3669.99169921875, 2440.3203125, 3674.0, 2421.0, 3667.590087890625, 2426.007568359375, 3673.0, 2437.0, 3672.96044921875, 2438.855712890625, 3673.00048828125, 2440.0, 3672.19287109375, 2428.92919921875, 3674.0, 2438.0, 3674.0, 2449.000244140625, 3677.193603515625, 2423.967041015625, 3675.95361328125, 2448.873779296875]

# R = [-2.4998216947886163, 1.886430972193955, -0.003634383119880336]

# T = [-16.488771896514017, -42.96707636785404, 503.5572090190583]


# m_L_t = np.array([[-3.11393338593189,-3.17047121806536,-3.34007998229936,-5.40185495337937,-2.85088814044138,-3.24667046219111,-2.85579291533213,-3.97419573023217,-2.88280724326614,-5.12668442656286,-2.88770231930539,-4.80971201020293,-4.97925405745627,-2.95402498182375,-2.97612923872657,-2.59006692602998,-2.80877412011614,-2.57021880644606,-3.63701377308462,-2.90684283879818,-4.15549602045212,-3.17717757279752,-4.08174114587018,-2.99031495221425,-2.93861212307820,-4.35198924480937,-3.03446676721796,-4.22171003674157,-2.79104724607896,-2.03861958405469,-2.88690468325513,-1.94757781847147,-2.00413698895136,-4.13555875868769,-2.81795429904014,-2.06552707985975,-2.20071300596464,-2.70968747249572,-3.99286451534135,-3.92392234265571,-4.07627629506169,-2.96758753020549,-3.70261001592735,-2.48070622497471,-2.82000757224159,-2.52001283707796,-3.40750008058967,-2.48552009667037,-2.63792806921992,-2.67723159940215,-3.69980307965307,-1.95162703533424,-2.60059114982141,-1.28244676633040,-2.35712716582930,-2.11364781518932,-2.73573812720133,-1.40516882593511,-1.84042924514506,-2.01011148793623,-1.87973258766579,-1.73208949371474,-3.31554986402625,-2.18935329292435,-2.35902071738383,-2.58523257303750,-2.68107640900416,-2.04171757923905,-2.15483417082578,-1.23254917131271,-2.64656063576695,-1.40703206451144,-1.74642535106977,-2.31201759917894,-2.42512637790060,-2.48167954158271,-1.84228711936157,-2.35131143219769,-3.02990748133743,-1.59876895078924,-2.93884421564871],
# [6.23879302106798,6.22229926520959,6.17281720740721,5.24790240079165,5.53984957979992,5.42440437804908,5.34447980159894,4.75963316857815,5.01335172867402,4.29400987504050,4.81796443928033,4.25722868973389,4.20774688478559,4.41068087657914,4.27491443604231,3.99950805725530,3.48305420391262,3.29391326475889,2.53011958487332,2.54898743517697,1.99083894398063,2.21144025679678,1.94766920665279,2.20123524731025,2.02224992355332,1.61012541269884,1.92961844010279,1.58343784417957,1.93589075375348,2.09050787193701,1.84325853828341,1.98765401402488,1.97117159189656,1.28513475600630,1.60459407186136,1.75919820927084,1.59041063068435,1.44207128370181,1.00329865235835,0.764630958903581,0.655515926424414,0.849327183794230,0.635068689938635,0.861824537161738,0.762940944172442,0.785667897667736,0.462304222397506,0.666313781403005,0.557196374516934,0.481038689147681,-0.0111067076213658,0.304221475962549,-0.208410928491503,0.110877494327724,-0.202185847330838,-0.195963308215141,-0.377211912535131,-0.313169182743877,-0.504666399676353,-0.554093833547086,-0.580832903739065,-0.667265549302101,-1.12857665214688,-0.994617379736155,-1.04404168715701,-1.10994091350585,-1.20258124638349,-1.08105425257236,-1.11400292674080,-0.910111973527819,-1.32196412933990,-1.15509844431654,-1.25393908564001,-1.41867438796908,-1.45162152824923,-1.46809510374442,-1.34658244810998,-1.49484250601381,-1.69252286339179,-1.34038697695360,-1.79543542955071],
# [0.320447520352900,0.322538412176073,0.328854707069695,0.399842030368745,0.283457817509770,0.298198400065303,0.276996918022633,0.311164010316134,0.267107120715082,0.354226279072464,0.260862252674997,0.336794736795127,0.343897823244333,0.250740949064493,0.247446553781629,0.220745756290853,0.215083614923060,0.198333475738764,0.226777023635805,0.192464265972376,0.237346255220473,0.195850913412869,0.232532365247607,0.186728307977319,0.179420847445726,0.237010771408677,0.181441264227033,0.229817416518927,0.170178605243564,0.139812170527875,0.172186162322760,0.132928617298603,0.135028737597168,0.217843547463417,0.162653142586350,0.132136471569538,0.133822058327496,0.153378951363266,0.203695257194340,0.194423343054950,0.199277483858168,0.150514724664390,0.180467677302659,0.128152793273330,0.141475836746395,0.128097239881754,0.162074405699968,0.123605761677027,0.128023058176041,0.128029155544937,0.165183503180742,0.0906983166933060,0.108569249510765,0.0566154448315501,0.0974992336705327,0.0865535233169794,0.111103669740260,0.0524024683982134,0.0674586249515414,0.0740017369389534,0.0675687259063125,0.0591253330931068,0.122538368217647,0.0727928495034576,0.0795109486207366,0.0885702474042773,0.0911288121715188,0.0643286788836122,0.0687711210921407,0.0320475492626429,0.0871236603707075,0.0346058430150151,0.0475843716412783,0.0697973808273673,0.0743272816762328,0.0766031434759498,0.0500023774802685,0.0700924880802631,0.0977957807481289,0.0393042508512735,0.0915395263582468]],
# dtype=np.float64)

# p_t = np.array([[3550.9932,3551.0066,3551.0002,3555.9478,3562.9966,3562.9993,3566,3569.9116,3571,3572.7771,3574,3574,3576.8350,3577.9575,3581.6128,3587.6797,3594.7605,3599.1370,3606.3149,3608.4658,3611.9993,3612.9524,3613.0054,3614,3616.9648,3617.0151,3618.0452,3618.0085,3618.9988,3619.9412,3620.0134,3621.9854,3622.0415,3622.9890,3623.3691,3624.6868,3627.4004,3627.0005,3628,3632.0376,3633.0984,3633.7195,3635.0334,3637.0313,3637.0046,3637.9993,3638.9226,3640,3641.0989,3641.9231,3644.9983,3648.0107,3653.9949,3654.1118,3653.9399,3654.9976,3655.1885,3659.9978,3659.0283,3659,3660,3664.9460,3664,3666.9927,3667.0078,3666.5972,3668.0029,3669.1248,3668.9995,3669.8362,3669.9917,3674,3667.5901,3673,3672.9604,3673.0005,3672.1929,3674,3674,3677.1936,3675.9536],
# [2413.0557,2414.0195,2417,2454.5510,2412.0103,2419.0007,2413.0007,2433.9956,2415,2455.1001,2416,2450,2451.6946,2418.3538,2419.8689,2414.9683,2421.0562,2417.6543,2438.9766,2427.2424,2450.0020,2433.1250,2449.0146,2431,2431.0510,2455.0720,2433.4507,2452.9331,2429.0017,2415.0535,2431.4141,2413.9978,2414.9902,2453.0195,2429.9021,2416.0110,2422.8921,2428.9998,2453,2452.9739,2455.1025,2437.5286,2448.9170,2428.9744,2434.1931,2429.9995,2444.9922,2430,2432.4888,2433.4958,2451.9968,2422.5796,2435.0210,2412.6604,2431.0271,2427.9668,2438.0095,2417.0020,2424.9851,2428,2426.0002,2423.0625,2451,2432.0042,2436.0193,2439.4385,2442.0115,2429.9778,2432.0012,2416.1174,2440.3203,2421,2426.0076,2437,2438.8557,2440,2428.9292,2438,2449.0002,2423.9670,2448.8738]],
# dtype=np.float64)

# R = np.array([
#    [0.2743,-0.9616,0.0078],
#    [-0.9616,-0.2743,0.0065],
#    [-0.0041,-0.0093,-0.9999]
# ])

# Rvec, _ = cv2.Rodrigues(R)
# rvec_cp = copy.deepcopy(Rvec)

# T = np.array([
#     -16.4888, -42.9671, 503.5572
# ]).T

# _,R,T = cv2.solvePnP(
#     m_L_t.T,
#     p_t.T,
#     K,
#     None,
#     flags=cv2.SOLVEPNP_ITERATIVE
# )

# print(rvec_cp, R)
# print(T)

m_L_t = np.array(p3_t, dtype=np.float64).reshape([int(np.size(p3_t)/3),3])
p_t = np.array(p2_t, dtype=np.float64).reshape([int(np.size(p2_t)/2),2])
# _,R,T = cv2.solvePnP(
#     m_L_t,
#     p_t,
#     K,
#     None,
#     np.array(R),
#     np.array(T),
#     False,
#     flags=cv2.SOLVEPNP_IPPE
# )

_,R,T,_ = cv2.solvePnPRansac(
    m_L_t,
    p_t,
    K,
    None,
    np.array(R),
    np.array(T),
    useExtrinsicGuess=True,
    flags=cv2.SOLVEPNP_IPPE,
    inliers=None
)

# R,T = cv2.solvePnPRefineLM(
#     m_L_t,
#     p_t,
#     K,
#     None,
#     np.array(R),
#     np.array(T),
# )





